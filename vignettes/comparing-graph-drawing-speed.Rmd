---
title: "Network Visualization with `ggplot2`"
author: "Samantha Tyner, Francoise Briatte, and Heike Hofmann"
date: "`r Sys.Date()`"
output: 
    rmarkdown::html_vignette:
        toc: true
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


```{r setup, echo=FALSE}

knitr::opts_chunk$set(fig.width = 6,
                      fig.height = 4,
                      fig.align='center',
                      dev = "png")

```

# Introduction

This vignette provides access to the online supplement to the paper ``Network Visualization with `ggplot2` ``. 

The code to access data for all of the examples and to reproduce all of the figures is available at [tyner-briatte-hofmann.R](https://raw.githubusercontent.com/sctyner/ggnet-paper/master/tyner-briatte-hofmann.R).

A summary of the speed comparisons is shown in the paper. A more detailed outline together with the code to reproduce findings is given in the next section.

# Speed Comparisons

This vignette compares the speeds of our package to the other `ggplot2`-based network visualization package `ggnetwork`, the `GGally` function `ggnet2()`, and the visualization capabilities of the `igraph` and `network` packages. 

## Speed Comparison 1 

In this first example, we visualize the protein-protein interaction network in the yeast species *S. cerevisiae* using several different methods.

First, load all of the necessary packages and data sets.

```{r speed1_loadpkg, echo = TRUE, eval = TRUE, message=FALSE, warning = FALSE}
## igraph (current: v1.0.1)
if (!require(igraph, quietly = TRUE)) {
  install.package("igraph")
}
library(igraph)

## network (current: v1.13.0)
if (!require(network, quietly = TRUE)) {
  install.package("network")
}
library(network)

## ggplot2
if (!require(ggnetwork, quietly = TRUE) ||
    packageVersion("ggplot2") < "1.0.1.9003") {
  devtools::install_github("hadley/ggplot2")
}
library(ggplot2)

## ggnet2
if (!require(GGally, quietly = TRUE)) {
  install.packages("GGally")
}
library(GGally)

## geom_net
if (!require(geomnet, quietly = TRUE)) {
  devtools::install_github("sctyner/geomnet")
}
library(geomnet) # also currently requires dplyr

## ggnetwork
if (!require(ggnetwork, quietly = TRUE)) {
  install.packages("ggnetwork")
}
library(ggnetwork)

## other packages
library(dplyr)
library(tidyr)

## pre-loading
library(scales)
library(sna)

## load data 
data(protein, package = "geomnet")
```

Next, generate the network visualization of this network 100 times using the random layout option in each package and store the time to plot each run. 

```{r speed1_simcode, eval=FALSE, echo=TRUE}
d = data.frame()

if (!file.exists("runtimes-protein-100.csv")) {
  
  for (i in 1:100) {
  
    cat("Iteration", sprintf("%3.0f", i), "/ 100\n")
  
    n = as.matrix(protein$edges[, 1:2])
    n = igraph::graph_from_edgelist(n, directed = FALSE)
  
    t1 = system.time({
      plot(n, vertex.label = NA, layout = layout_randomly)
    })[1]
  
    n = network(protein$edges[, 1:2], directed = FALSE)

    t2 = system.time({
     plot(n, coord = gplot.layout.random(n, NULL))
    })[1]

    t3 = system.time({
      print(ggnet2(n, mode = "random"))
    })[1]

    t4 = system.time({
      print(ggplot(data = protein$edges, aes(from_id = from, to_id = to)) +
              geom_net(layout = "random"))
    })[1]

    t5 = system.time({
      print(ggplot(ggnetwork(n, layout = "random"),
                   aes(x, y, xend = xend, yend = yend)) +
              geom_edges() +
              geom_nodes())
    })[1]
  
    d = rbind(d, data.frame(
      iteration = i,
      igraph = t1,
      network = t2,
      ggnet2 = t3,
      geomnet = t4,
      ggnetwork = t5,
      row.names = NULL
    ))

  }

  write.csv(d, file = "runtimes-protein-100.csv", row.names = FALSE)
  
}
```

Finally, compare the 100 runtimes for each method side-by-side.

```{r speed1_plot, echo=TRUE}
link_to_data <- "https://raw.githubusercontent.com/sctyner/ggnet-paper/master/runtimes-protein/runtimes-protein-100.csv"

g = read.csv(link_to_data, stringsAsFactors = FALSE) %>%
      gather(`Visualization approach`, time, -iteration)

ggplot(g, aes(x = `Visualization approach`, y = time,
              fill = `Visualization approach`)) +
  geom_boxplot() +
  scale_fill_brewer(palette = "Set2") +
  coord_flip() +
  labs(y = "\nPlotting time (in seconds)", x = "Implementation\n") +
  guides(fill = FALSE) 
```


## Comparing different systems

The second test relies on random undirected networks in which the probability of an edge 
between two nodes was set to $p = 0.2$.
We generated 100 of these networks at network sizes from 25 to 250 nodes, using increments of 25.


```{r all-runtimes, eval=TRUE, echo=FALSE, fig.width = 8, fig.height = 8}
link_to_full_comparison <- "https://raw.githubusercontent.com/sctyner/ggnet-paper/master/data/compare-all.csv"
g <- readr::read_csv(link_to_full_comparison)

qplot(data = g, network_size, time, colour = `Visualization approach`, alpha = I(0.1)) +
  facet_wrap(facets = ~setup, scales = "free_y") +
  geom_smooth(fill="white") +
  scale_colour_brewer("Implementation", palette = "Set1") +
  xlab("Network size (edge probability p = 0.2)") +
  ylab("Time (in seconds)") +
  theme_bw() +
  theme(legend.position = "bottom")
```


The figure summarizes the results of these benchmarks using a convenience sample of machines accessible to the authors, including authors' hardware and additional results from friends' and colleagues' machines.
Network sizes are plotted horizontally, execution times of 100 runs under each visualization approach are plotted on the $y$-axis. Each panel shows a different machine as indicated by the facet label. Note that each panel is scaled separately to account for differences in the overall speed of these machines.
What these plots indicate is that we have surprisingly large variability in relative run times across different machines.
However, the results support some  general findings.
The  plotting routine in the network package  is by far the slowest across all machines, while the  plotting with `igraph` is generally among the fastest. Our three approaches generally feature in between these two, with `ggnet2` being as fast or faster than `igraph` plotting, followed by `ggnetwork` and `geomnet`, which is generally the slowest among the three. These differences become more pronounced as the size of the network increases.
